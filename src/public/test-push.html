<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Prueba Push</title>
</head>
<body>
  <h1>Prueba de notificaciones Push</h1>
  <button id="btnSub">Suscribirme y guardar en backend</button>

  <pre id="log" style="margin-top:16px; background:#111; color:#0f0; padding:10px; max-width:600px; white-space:pre-wrap;"></pre>

  <script>
    const logEl = document.getElementById('log');
    const btn = document.getElementById('btnSub');

    // ‚ö†Ô∏è Pega aqu√≠ tu VAPID_PUBLIC_KEY (la p√∫blica, igual que en .env)
    const VAPID_PUBLIC_KEY = "TU_VAPID_PUBLIC_KEY_AQU√ç";

    // helper para transformar la key a Uint8Array
    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, "+")
        .replace(/_/g, "/");

      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    function log(msg) {
      console.log(msg);
      logEl.textContent += msg + "\n";
    }

    btn.addEventListener('click', async () => {
      try {
        if (!('serviceWorker' in navigator)) {
          return log("‚ùå Service Workers no soportados.");
        }
        if (!('PushManager' in window)) {
          return log("‚ùå Push API no soportada.");
        }

        log("üì¶ Registrando Service Worker...");
        const reg = await navigator.serviceWorker.register('/sw.js');
        log("‚úÖ SW registrado.");

        log("üîî Solicitando permiso de notificaci√≥n...");
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') {
          return log("‚ùå Permiso de notificaci√≥n no concedido.");
        }
        log("‚úÖ Permiso concedido.");

        log("üì° Creando suscripci√≥n...");
        const subscription = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });

        log("‚úÖ Suscripci√≥n creada:");
        log(JSON.stringify(subscription, null, 2));

        // ‚ö†Ô∏è IMPORTANTE:
        // Cambia estos valores a algo real de tu backend
        const userId = "ID_DE_USUARIO_DE_PRUEBA"; // aqu√≠ pon el _id de Mongo o algo que exista
        const token = "TOKEN_JWT_DE_PRUEBA"; // si tu /tikets requiere auth

        log("üì§ Enviando suscripci√≥n al backend...");
        const res = await fetch('http://localhost:3000/tikets/push/subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}` // si tu authMiddleware lo exige
          },
          body: JSON.stringify({ userId, subscription })
        });

        const data = await res.json();
        log("‚úÖ Respuesta backend:");
        log(JSON.stringify(data, null, 2));
      } catch (err) {
        console.error(err);
        log("‚ùå Error: " + err.message);
      }
    });
  </script>
</body>
</html>
